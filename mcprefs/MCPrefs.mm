
#define WhiteColour [UIColor colorWithRed:255/255.0f green:255/255.0f blue:255/255.0f alpha:1.0f]
#define BlackColour [UIColor colorWithRed:0/255.0f green:0/255.0f blue:0/255.0f alpha:1.0f]
#define DarkGreyColour [UIColor colorWithRed:100/255.0f green:100/255.0f blue:100/255.0f alpha:1.0f]
#define LightGreyColour [UIColor colorWithRed:227/255.0f green:229/255.0f blue:233/255.0f alpha:1.0f]
#define DarkBlueColour [UIColor colorWithRed:0/255.0f green:122/255.0f blue:255/255.0f alpha:1.0f]
#define LightBlueColour [UIColor colorWithRed:25/255.0f green:213/255.0f blue:253/255.0f alpha:1.0f]
#define GreenColour [UIColor colorWithRed:76/255.0f green:217/255.0f blue:100/255.0f alpha:1.0f]
#define RedColour [UIColor colorWithRed:255/255.0f green:59/255.0f blue:48/255.0f alpha:1.0f]
#define OrangeColour [UIColor colorWithRed:255/255.0f green:149/255.0f blue:0/255.0f alpha:1.0f]
#define YellowColour [UIColor colorWithRed:255/255.0f green:204/255.0f blue:0/255.0f alpha:1.0f]
#define PinkColour [UIColor colorWithRed:255/255.0f green:45/255.0f blue:85/255.0f alpha:1.0f]
#define PurpleColour [UIColor colorWithRed:88/255.0f green:86/255.0f blue:214/255.0f alpha:1.0f]
#define TealColour [UIColor colorWithRed:52/255.0f green:170/255.0f blue:220/255.0f alpha:1.0f]
#define MaroonColour [UIColor colorWithRed:114/255.0f green:36/255.0f blue:61/255.0f alpha:1.0f]

#define WhiteGradTopCol [UIColor colorWithRed:227/255.0f green:229/255.0f blue:233/255.0f alpha:1.0f];
#define WhiteGradBotCol [UIColor colorWithRed:1 green:1 blue:1 alpha:1];
#define BlackGradTopCol [UIColor colorWithRed:17/255.0f green:17/255.0f blue:17/255.0f alpha:1.0f]
#define BlackGradBotCol [UIColor colorWithRed:46/255.0f green:46/255.0f blue:46/255.0f alpha:1.0f]
#define DarkGreyGradTopCol [UIColor colorWithRed:150/255.0f green:150/255.0f blue:150/255.0f alpha:1.0f]
#define DarkGreyGradBotCol [UIColor colorWithRed:200/255.0f green:200/255.0f blue:200/255.0f alpha:1.0f]
#define LightGreyGradTopCol [UIColor colorWithRed:227/255.0f green:229/255.0f blue:233/255.0f alpha:1.0f]
#define LightGreyGradBotCol [UIColor colorWithRed:240/255.0f green:240/255.0f blue:245/255.0f alpha:1.0f]
#define DarkBlueGradTopCol [UIColor colorWithRed:58/255.0f green:59/255.0f blue:225/255.0f alpha:1.0f]
#define DarkBlueGradBotCol [UIColor colorWithRed:58/255.0f green:132/255.0f blue:237/255.0f alpha:1.0f]
#define LightBlueGradTopCol [UIColor colorWithRed:64/255.0f green:145/255.0f blue:254/255.0f alpha:1.0f]
#define LightBlueGradBotCol [UIColor colorWithRed:63/255.0f green:192/255.0f blue:255/255.0f alpha:1.0f]
#define GreenGradTopCol [UIColor colorWithRed:106/255.0f green:186/255.0f blue:50/255.0f alpha:1.0f]
#define GreenGradBotCol [UIColor colorWithRed:160/255.0f green:233/255.0f blue:59/255.0f alpha:1.0f]
#define RedGradTopCol [UIColor colorWithRed:225/255.0f green:29/255.0f blue:60/255.0f alpha:1.0f]
#define RedGradBotCol [UIColor colorWithRed:255/255.0f green:86/255.0f blue:30/255.0f alpha:1.0f]
#define OrangeGradTopCol [UIColor colorWithRed:255/255.0f green:151/255.0f blue:3/255.0f alpha:1.0f]
#define OrangeGradBotCol [UIColor colorWithRed:254/255.0f green:190/255.0f blue:62/255.0f alpha:1.0f]
#define YellowGradTopCol [UIColor colorWithRed:255/255.0f green:194/255.0f blue:0/255.0f alpha:1.0f]
#define YellowGradBotCol [UIColor colorWithRed:255/255.0f green:241/255.0f blue:62/255.0f alpha:1.0f]
#define PinkGradTopCol [UIColor colorWithRed:222/255.0f green:85/255.0f blue:224/255.0f alpha:1.0f]
#define PinkGradBotCol [UIColor colorWithRed:245/255.0f green:134/255.0f blue:255/255.0f alpha:1.0f]
#define PurpleGradTopCol [UIColor colorWithRed:149/255.0f green:59/255.0f blue:237/255.0f alpha:1.0f]
#define PurpleGradBotCol [UIColor colorWithRed:222/255.0f green:85/255.0f blue:224/255.0f alpha:1.0f]
#define TealGradTopCol [UIColor colorWithRed:48/255.0f green:182/255.0f blue:193/255.0f alpha:1.0f]
#define TealGradBotCol [UIColor colorWithRed:59/255.0f green:233/255.0f blue:205/255.0f alpha:1.0f]
#define MaroonGradTopCol [UIColor colorWithRed:114/255.0f green:36/255.0f blue:61/255.0f alpha:1.0f]
#define MaroonGradBotCol [UIColor colorWithRed:191/255.0f green:20/255.0f blue:71/255.0f alpha:1.0f]

#import <Preferences/Preferences.h>
#import <MobileCoreServices/MobileCoreServices.h>
#import <AssetsLibrary/ALAssetsLibrary.h>
#import <AssetsLibrary/ALAsset.h>
#import <AssetsLibrary/ALAssetRepresentation.h>
#import <UIKit/UIPreferencesTable.h>
#import "UIImage+ImageEffects.h"
#import <MessageUI/MessageUI.h>
#import <Social/Social.h>

#import <sys/utsname.h>

@interface UIImage (chew)
+(id) imageWithContentsOfCPBitmapFile:(id)arg1 flags:(NSInteger)arg2;
@end

NSString*
machineName() {
    struct utsname systemInfo;
    uname(&systemInfo);

    return [NSString stringWithCString:systemInfo.machine
            encoding:NSUTF8StringEncoding];
}

static CGFloat prefsWidth = 295;
static BOOL iPad = UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPad;

@interface CHMCPSListController:PSListController
@end

@implementation CHMCPSListController

#define prefsPath @"/User/Library/Preferences/me.chewitt.MCPrefs.plist"

-(id) readPreferenceValue:(PSSpecifier*)spec {
    NSDictionary* dic = [NSDictionary dictionaryWithContentsOfFile:prefsPath] ? :[NSDictionary dictionary];
    id val = nil;
    if (! dic[spec.properties[@"key"]]) {
        val = spec.properties[@"default"];
    }
    else {
        val = dic[spec.properties[@"key"]];
    }

    if ([spec.properties[@"negate"] boolValue]) {
        val = [NSNumber numberWithInt:(NSInteger) ! [val boolValue]];
    }
    return val;
}

-(void) setPreferenceValue:(id)value specifier:(PSSpecifier*)spec {
    [super setPreferenceValue:value specifier:spec];
    NSMutableDictionary* defaults = [NSMutableDictionary dictionary] ? :[NSMutableDictionary dictionary];
    [defaults addEntriesFromDictionary:[NSDictionary dictionaryWithContentsOfFile:prefsPath]];
    if ([spec.properties[@"negate"] boolValue]) {
        [defaults setObject:[NSNumber numberWithInt:(NSInteger) ! [value boolValue]] forKey:spec.properties[@"key"]];
    }
    else {
        [defaults setObject:value forKey:spec.properties[@"key"]];
    }
    [defaults writeToFile:prefsPath atomically:YES];
    CFStringRef toPost = (__bridge CFStringRef)spec.properties[@"PostNotification"];
    if (toPost) {
        CFNotificationCenterPostNotification(CFNotificationCenterGetDarwinNotifyCenter(), toPost, NULL, NULL, YES);
    }
}

-(void) viewDidAppear:(BOOL)a {
    [super viewDidAppear:a];
    prefsWidth = self.view.frame.size.width - 25;
}

@end

@interface MCPrefsListController:CHMCPSListController  <UIAlertViewDelegate, MFMailComposeViewControllerDelegate> {}
-(void) openDonateLink;
-(void) openEmailLink;
-(void) resetDefaults;
@end

@implementation MCPrefsListController

-(id) specifiers {
    if (_specifiers == nil) {
        UIBarButtonItem* likeButton = [[UIBarButtonItem alloc] initWithImage:[UIImage imageWithContentsOfFile:@"/Library/PreferenceBundles/MCPrefs.bundle/heart.png"] style:UIBarButtonItemStylePlain target:self action:@selector(composeTweet)];
        ((UINavigationItem*)self.navigationItem).rightBarButtonItem = likeButton;
        //[likeButton release];
        _specifiers = [self loadSpecifiersFromPlistName:@"MCPrefs" target:self];        // retain];
    }
    return _specifiers;
}

-(void) composeTweet {
    if ([SLComposeViewController isAvailableForServiceType:SLServiceTypeTwitter]) {
        SLComposeViewController* tweetSheet = [SLComposeViewController composeViewControllerForServiceType:SLServiceTypeTwitter];
        [tweetSheet setInitialText:@"I'm using MessagesCustomiser (by @friggog) to make my messages app look awesome!"];
        UIViewController* rootViewController = (UIViewController*)[[[UIApplication sharedApplication] keyWindow] rootViewController];
        [rootViewController presentViewController:tweetSheet animated:YES completion:nil];
    }
    else {
        UIAlertView* alert = [[UIAlertView alloc] initWithTitle:@"Error"
                              message:@"Unable to tweet at this time."
                              delegate:self
                              cancelButtonTitle:@"OK"
                              otherButtonTitles:nil];
        [alert show];
        //[alert release];
    }
}

-(void) openDonateLink {
    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:@"http://bitly.com/1ezK2Cp"]];
}

-(void) openEmailLink {
    NSString* currSysVer = [[UIDevice currentDevice] systemVersion];
    NSString* tweakVer = @"3.1.0";
    NSString* device = machineName();

    /*
       NSString *recipients = [NSString stringWithFormat:@"mailto:contact@chewitt.me?cc=&subject=Messages Customiser %@ - %@ : %@",tweakVer,device,currSysVer];
       NSString *body = @"&body=";
       NSString *email = [NSString stringWithFormat:@"%@%@", recipients, body];
       email = [email stringByAddingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
       [[UIApplication sharedApplication] openURL:[NSURL URLWithString:email]];
     */

    if ([MFMailComposeViewController canSendMail]) {
        MFMailComposeViewController* picker = [[MFMailComposeViewController alloc] init];
        picker.mailComposeDelegate = self;
        [picker setSubject:[NSString stringWithFormat:@"Messages Customiser %@ - %@ : %@", tweakVer, device, currSysVer]];

        NSArray* toRecipients = [NSArray arrayWithObject:@"contact@chewitt.me"];
        [picker setToRecipients:toRecipients];

        UIViewController* rootViewController = (UIViewController*)[[[UIApplication sharedApplication] keyWindow] rootViewController];
        [rootViewController presentViewController:picker animated:YES completion:NULL];
    }
    else {
        UIAlertView* alert = [[UIAlertView alloc] initWithTitle:@"Error"
                              message:@"You seem to be unable to send emails."
                              delegate:self
                              cancelButtonTitle:@"OK"
                              otherButtonTitles:nil
                              , nil];
        [alert show];
        //  [alert release];
    }
}

-(void) mailComposeController:(MFMailComposeViewController*)controller didFinishWithResult:(MFMailComposeResult)result error:(NSError*)error {
    [controller dismissViewControllerAnimated:YES completion:NULL];
}

-(void) openTwitterLink {
    NSURL* appURL = [NSURL URLWithString:@"twitter:///user?screen_name=friggog"];
    if ([[UIApplication sharedApplication] canOpenURL:appURL]) {
        [[UIApplication sharedApplication] openURL:appURL];
    }
    else {
        [[UIApplication sharedApplication] openURL:[NSURL URLWithString:@"http://twitter.com/friggog"]];
    }
}

-(void) resetDefaults {
    UIAlertView* alert = [[UIAlertView alloc] initWithTitle:@"Really reset?"
                          message:@"Do you really want to restore default settings?"
                          delegate:self
                          cancelButtonTitle:@"Cancel"
                          otherButtonTitles:@"Yes", nil];
    [alert show];
}

-(void) alertView:(UIAlertView*)alertView clickedButtonAtIndex:(NSInteger)buttonIndex {
    if (buttonIndex == 1) {//TODO
        NSData* data = [[NSData alloc] initWithBytes:nil length:0];
        NSString* dir = @"/var/mobile/Library/Preferences/me.chewitt.MCPrefs.plist";
        [data writeToFile:dir atomically:YES];
        [NSUserDefaults resetStandardUserDefaults];
        [[NSUserDefaults standardUserDefaults] synchronize];
        [self reloadSpecifiers];
        //strcpy(0, "crash :P");
    }
}

-(void) goToMCPro {
    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:@"cydia://package/me.chewitt.mcpro"]];
}

@end

@interface BubblesController:CHMCPSListController {
    BOOL gradient;
    BOOL idsSet;
    NSInteger bubbleColourID;
    UIView* bubbleTopColourPreview;
    UIView* bubbleBotColourPreview;
    UIView* textColourPreview;

    NSString* prefsName;  //SMSPrefs
    NSString* gradientName;  //SMSBubbleGradient

    NSString* bubbleTopRedName;  //SMSBubbleTopRed
    NSString* bubbleTopGreenName;  //SMSBubbleTopGreen
    NSString* bubbleTopBlueName;  //SMSBubbleTopBlue
    NSString* bubbleTopAlphaName;  //SMSBubbleTopAlpha

    NSString* bubbleBotRedName;  //SMSBubbleBotRed
    NSString* bubbleBotGreenName;  //SMSBubbleBotGreen
    NSString* bubbleBotBlueName;  //SMSBubbleBotBlue
    NSString* bubbleBotAlphaName;  //SMSBubbleBotAlpha

    NSString* textRedName;  //SMSTextRed
    NSString* textGreenName;  //SMSTextGreen
    NSString* textBlueName;  //SMSTextBlue
    NSString* textAlphaName;  //SMSTextAlpha

    NSString* bubblePresetName;  //SMSBubbleColour
    NSString* textPresetName;  //SMSTextColour
}
@property (nonatomic, retain) PSSpecifier* bubblePresetSpecifier;
@property (nonatomic, retain) PSSpecifier* textPresetSpecifier;
-(void) setIDs;
-(void) topBubbleSliderAlteredTo:(id)value specifier:(id)specifier;
-(void) botBubbleSliderAlteredTo:(id)value specifier:(id)specifier;
-(void) setBubblePreset:(id)value specifier:(id)specifier;
-(void) setBubbleGradient:(id)value forSpecifier:(id)specifier;
-(void) setTextPreset:(id)value forSpecifier:(id)specifier;
-(void) textSliderAlteredTo:(id)value specifier:(id)specifier;
-(void) invertGradient;
-(void) updateBubblePreviewColourInTime:(CGFloat)t;
-(void) updateTextPreviewInTime:(CGFloat)t;
@end

@implementation BubblesController

-(void) setIDs {}

-(id) specifiers {
    if (! idsSet) {
        [self setIDs];
    }

    if (_specifiers == nil) {
        _specifiers = [self loadSpecifiersFromPlistName:prefsName target:self];
        gradient = [[self readPreferenceValue:[self specifierForID:gradientName]] boolValue];
        bubbleColourID = [[self readPreferenceValue:[self specifierForID:bubblePresetName]] integerValue];
        if (bubbleColourID == 42) {
            NSMutableArray* a = [[NSMutableArray alloc] init];
            for (NSInteger i = 0; i < _specifiers.count; i++) {
                if (i != 1 && i != 3 && i != 6 && i != 7 && i != 8 && i != 9 && i != 10 && i != 11 && i != 12 && i != 13) {
                    [a addObject:[_specifiers objectAtIndex:i]];
                }
            }
            _specifiers = [a copy];
            //[a release];
        }
        else if (! gradient) {
            NSMutableArray* a = [[NSMutableArray alloc] init];
            for (NSInteger i = 0; i < _specifiers.count; i++) {
                if (i != 3 && i != 10 && i != 11 && i != 12 && i != 13) {
                    [a addObject:[_specifiers objectAtIndex:i]];
                }
            }
            _specifiers = [a copy];
        }

        self.bubblePresetSpecifier = [self specifierForID:bubblePresetName];
        self.textPresetSpecifier = [self specifierForID:textPresetName];
    }

    if (! bubbleTopColourPreview) {
        CGFloat rVal = 0;
        CGFloat gVal = 0;
        CGFloat bVal = 0;
        CGFloat aVal = 0;
        if (bubbleColourID != 42) {
            rVal = [[self readPreferenceValue:[self specifierForID:bubbleTopRedName]] integerValue];
            gVal = [[self readPreferenceValue:[self specifierForID:bubbleTopGreenName]] integerValue];
            bVal = [[self readPreferenceValue:[self specifierForID:bubbleTopBlueName]] integerValue];
            aVal = [[self readPreferenceValue:[self specifierForID:bubbleTopAlphaName]] integerValue];
        }
        UIColor* colour = [UIColor colorWithRed:rVal/255.0 green:gVal/255.0 blue:bVal/255.0 alpha:aVal/100.0];
        UIView* view = nil;
        if (! gradient) {
            view = [[UIView alloc] initWithFrame:CGRectMake(prefsWidth, 275, 15, 15)];
        }
        else {
            view = [[UIView alloc] initWithFrame:CGRectMake(prefsWidth, 320, 15, 15)];
        }
        view.backgroundColor = colour;
        view.layer.cornerRadius = 7.5;
        [self.table addSubview:view];
        bubbleTopColourPreview = view;
        //[view release];
    }
    if (! bubbleBotColourPreview) {
        UIColor* colour = [UIColor clearColor];
        if (gradient) {
            CGFloat rVal = [[self readPreferenceValue:[self specifierForID:bubbleBotRedName]] integerValue];
            CGFloat gVal = [[self readPreferenceValue:[self specifierForID:bubbleBotGreenName]] integerValue];
            CGFloat bVal = [[self readPreferenceValue:[self specifierForID:bubbleBotBlueName]] integerValue];
            CGFloat aVal = [[self readPreferenceValue:[self specifierForID:bubbleBotAlphaName]] integerValue];
            colour = [UIColor colorWithRed:rVal/255.0 green:gVal/255.0 blue:bVal/255.0 alpha:aVal/100.0];
        }
        UIView* view = nil;
        if (! gradient) {
            view = [[UIView alloc] initWithFrame:CGRectMake(prefsWidth, 462, 15, 15)];
            view.alpha = 0;
        }
        else {
            view = [[UIView alloc] initWithFrame:CGRectMake(prefsWidth, 507, 15, 15)];
        }
        view.backgroundColor = colour;
        view.layer.cornerRadius = 7.5;
        [self.table addSubview:view];
        bubbleBotColourPreview = view;
        //[view release];
    }
    if (! textColourPreview) {
        UIColor* colour = nil;
        CGFloat rVal = [[self readPreferenceValue:[self specifierForID:textRedName]] integerValue];
        CGFloat gVal = [[self readPreferenceValue:[self specifierForID:textGreenName]] integerValue];
        CGFloat bVal = [[self readPreferenceValue:[self specifierForID:textBlueName]] integerValue];
        colour = [UIColor colorWithRed:rVal/255.0 green:gVal/255.0 blue:bVal/255.0 alpha:1];
        UIView* view = nil;
        if (bubbleColourID == 42) {
            view = [[UIView alloc] initWithFrame:CGRectMake(prefsWidth, 232, 15, 15)];
        }
        else if (! gradient) {
            view = [[UIView alloc] initWithFrame:CGRectMake(prefsWidth, 464, 15, 15)];
        }
        else {
            view = [[UIView alloc] initWithFrame:CGRectMake(prefsWidth, 694, 15, 15)];
        }
        view.backgroundColor = colour;
        view.layer.cornerRadius = 7.5;
        [self.table addSubview:view];
        textColourPreview = view;
        //  [view release];
    }
    return _specifiers;
}

-(void) setBubblePreset:(id)value specifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];
    NSInteger val = [value integerValue];
    NSInteger oldID = bubbleColourID;
    bubbleColourID = val;
    if (val == 42) {
        textColourPreview.frame = CGRectMake(prefsWidth, 232, 15, 15);
        bubbleBotColourPreview.alpha = 0;
        bubbleTopColourPreview.alpha = 0;
        [self setPreferenceValue:[NSNumber numberWithInt:0] specifier:[self specifierForID:gradientName]];
    }
    else {
        if (oldID == 42) {
            [self reloadSpecifiers];
            bubbleTopColourPreview.alpha = 1;
            textColourPreview.frame = CGRectMake(prefsWidth, 464, 15, 15);
        }
        if (! gradient) {
            UIColor* col = nil;
            switch (val) {
                case 1:
                    col = WhiteColour;
                    break;

                case 2:
                    col = BlackColour;
                    break;

                case 3:
                    col = DarkGreyColour;
                    break;

                case 4:
                    col = LightGreyColour;
                    break;

                case 5:
                    col = DarkBlueColour;
                    break;

                case 6:
                    col = LightBlueColour;
                    break;

                case 7:
                    col = GreenColour;
                    break;

                case 8:
                    col = RedColour;
                    break;

                case 9:
                    col = OrangeColour;
                    break;

                case 10:
                    col = YellowColour;
                    break;

                case 11:
                    col = PinkColour;
                    break;

                case 12:
                    col = PurpleColour;
                    break;

                case 13:
                    col = TealColour;
                    break;

                case 14:
                    col = MaroonColour;
                    break;

                default:
                    col = nil;
                    break;
            }
            if (col) {
                const CGFloat* components = CGColorGetComponents(col.CGColor);
                [self setPreferenceValue:[NSNumber numberWithInt:components[0]*255] specifier:[self specifierForID:bubbleTopRedName]];
                [self setPreferenceValue:[NSNumber numberWithInt:components[1]*255] specifier:[self specifierForID:bubbleTopGreenName]];
                [self setPreferenceValue:[NSNumber numberWithInt:components[2]*255] specifier:[self specifierForID:bubbleTopBlueName]];
            }
        }
        else {
            UIColor* cTop = nil;
            UIColor* cBot = nil;
            switch (val) {
                case 1:
                    cTop = WhiteGradTopCol;
                    cBot = WhiteGradBotCol;
                    break;

                case 2:
                    cTop = BlackGradTopCol;
                    cBot = BlackGradBotCol;
                    break;

                case 3:
                    cTop = DarkGreyGradTopCol;
                    cBot = DarkGreyGradBotCol;
                    break;

                case 4:
                    cTop = LightGreyGradTopCol;
                    cBot = LightGreyGradBotCol;
                    break;

                case 5:
                    cTop = DarkBlueGradTopCol;
                    cBot = DarkBlueGradBotCol;
                    break;

                case 6:
                    cTop = LightBlueGradTopCol;
                    cBot = LightBlueGradBotCol;
                    break;

                case 7:
                    cTop = GreenGradTopCol;
                    cBot = GreenGradBotCol;
                    break;

                case 8:
                    cTop = RedGradTopCol;
                    cBot = RedGradBotCol;
                    break;

                case 9:
                    cTop = OrangeGradTopCol;
                    cBot = OrangeGradBotCol;
                    break;

                case 10:
                    cTop = YellowGradTopCol;
                    cBot = YellowGradBotCol;
                    break;

                case 11:
                    cTop = PinkGradTopCol;
                    cBot = PinkGradBotCol;
                    break;

                case 12:
                    cTop = PurpleGradTopCol;
                    cBot = PurpleGradBotCol;
                    break;

                case 13:
                    cTop = TealGradTopCol;
                    cBot = TealGradBotCol;
                    break;

                case 14:
                    cTop = MaroonGradTopCol;
                    cBot = MaroonGradBotCol;
                    break;

                default:
                    nil;
                    break;
            }
            if (cTop && cBot) {
                const CGFloat* componentsTop = CGColorGetComponents(cTop.CGColor);
                [self setPreferenceValue:[NSNumber numberWithInt:componentsTop[0]*255] specifier:[self specifierForID:bubbleTopRedName]];
                [self setPreferenceValue:[NSNumber numberWithInt:componentsTop[1]*255] specifier:[self specifierForID:bubbleTopGreenName]];
                [self setPreferenceValue:[NSNumber numberWithInt:componentsTop[2]*255] specifier:[self specifierForID:bubbleTopBlueName]];
                const CGFloat* componentsBot = CGColorGetComponents(cBot.CGColor);
                [self setPreferenceValue:[NSNumber numberWithInt:componentsBot[0]*255] specifier:[self specifierForID:bubbleBotRedName]];
                [self setPreferenceValue:[NSNumber numberWithInt:componentsBot[1]*255] specifier:[self specifierForID:bubbleBotGreenName]];
                [self setPreferenceValue:[NSNumber numberWithInt:componentsBot[2]*255] specifier:[self specifierForID:bubbleBotBlueName]];
            }
        }
    }
    [[NSUserDefaults standardUserDefaults] synchronize];
    [self performSelector:@selector(reloadSpecifiers) withObject:self afterDelay:0.3];
    [self updateBubblePreviewColourInTime:0.3];
}

-(void) setBubbleGradient:(id)value forSpecifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];
    BOOL val = [value boolValue];
    gradient = val;
    if (! gradient) {
        [self removeSpecifier:[self specifierForID:@"BotColourGroup"] animated:YES];
        [self removeSpecifier:[self specifierForID:@"InvertGradient"] animated:YES];
        [UIView animateWithDuration:0.3f animations:^{
            bubbleTopColourPreview.frame = CGRectMake(prefsWidth, 275, 15, 15);
            bubbleBotColourPreview.frame = CGRectMake(prefsWidth, 462, 15, 15);
            bubbleBotColourPreview.alpha = 0;
            textColourPreview.frame = CGRectMake(prefsWidth, 464, 15, 15);
        }];
    }
    else {
        id prefs = [self loadSpecifiersFromPlistName:prefsName target:self];
        [self insertSpecifier:[prefs objectAtIndex:3] afterSpecifier:[self specifierForID:bubblePresetName] animated:YES];
        NSInteger start = [self indexOfSpecifierID:bubbleTopBlueName];
        [self insertSpecifier:[prefs objectAtIndex:10] afterSpecifier:[_specifiers objectAtIndex:start] animated:YES];
        [self insertSpecifier:[prefs objectAtIndex:11] afterSpecifier:[_specifiers objectAtIndex:start+1] animated:YES];
        [self insertSpecifier:[prefs objectAtIndex:12] afterSpecifier:[_specifiers objectAtIndex:start+2] animated:YES];
        [self insertSpecifier:[prefs objectAtIndex:13] afterSpecifier:[_specifiers objectAtIndex:start+3] animated:YES];
        [UIView animateWithDuration:0.3 animations:^{
            bubbleTopColourPreview.frame = CGRectMake(prefsWidth, 320, 15, 15);
            bubbleBotColourPreview.frame = CGRectMake(prefsWidth, 507, 15, 15);
            bubbleBotColourPreview.alpha = 1;
            textColourPreview.frame = CGRectMake(prefsWidth, 694, 15, 15);
        }];
    }
    [self setBubblePreset:[NSNumber numberWithInt:bubbleColourID] specifier:[self specifierForID:bubblePresetName]];
}

-(void) topBubbleSliderAlteredTo:(id)value specifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];
    if (bubbleColourID != 42) {
        CGFloat rVal = [[self readPreferenceValue:[self specifierForID:bubbleTopRedName]] integerValue];
        CGFloat gVal = [[self readPreferenceValue:[self specifierForID:bubbleTopGreenName]] integerValue];
        CGFloat bVal = [[self readPreferenceValue:[self specifierForID:bubbleTopBlueName]] integerValue];
        CGFloat aVal = [[self readPreferenceValue:[self specifierForID:bubbleTopAlphaName]] integerValue];
        UIColor* testColour = [UIColor colorWithRed:rVal/255.0 green:gVal/255.0 blue:bVal/255.0 alpha:aVal/100.0];
        [self updateBubblePreviewColourInTime:0.1];
        if (specifier != [self specifierForID:bubbleTopAlphaName]) {
            if (testColour != WhiteColour && testColour != BlackColour && testColour != DarkBlueColour  && testColour != LightBlueColour  && testColour != DarkGreyColour && testColour != LightGreyColour && testColour != GreenColour && testColour != RedColour && testColour != OrangeColour && testColour != YellowColour && testColour != PinkColour && testColour != PurpleColour && testColour != TealColour && testColour != MaroonColour) {
                [self setPreferenceValue:[NSNumber numberWithInt:20] specifier:[self specifierForID:bubblePresetName]];
                bubbleColourID = 20;
                [self reloadSpecifier:[self specifierForID:bubblePresetName]];
            }
        }
    }
    [[NSUserDefaults standardUserDefaults] synchronize];
}

-(void) botBubbleSliderAlteredTo:(id)value specifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];
    CGFloat rVal = [[self readPreferenceValue:[self specifierForID:bubbleBotRedName]] integerValue];
    CGFloat gVal = [[self readPreferenceValue:[self specifierForID:bubbleBotGreenName]] integerValue];
    CGFloat bVal = [[self readPreferenceValue:[self specifierForID:bubbleBotBlueName]] integerValue];
    CGFloat aVal = [[self readPreferenceValue:[self specifierForID:bubbleBotAlphaName]] integerValue];
    UIColor* testColour = [UIColor colorWithRed:rVal/255.0 green:gVal/255.0 blue:bVal/255.0 alpha:aVal/100.0];
    [self updateBubblePreviewColourInTime:0.1];
    if (specifier != [self specifierForID:bubbleBotAlphaName]) {
        if (testColour != WhiteColour && testColour != BlackColour && testColour != DarkBlueColour  && testColour != LightBlueColour  && testColour != DarkGreyColour && testColour != LightGreyColour && testColour != GreenColour && testColour != RedColour && testColour != OrangeColour && testColour != YellowColour && testColour != PinkColour && testColour != PurpleColour && testColour != TealColour && testColour != MaroonColour) {
            [self setPreferenceValue:[NSNumber numberWithInt:20] specifier:[self specifierForID:bubblePresetName]];
            bubbleColourID = 20;
            [self reloadSpecifier:[self specifierForID:bubblePresetName]];
        }
    }
    [[NSUserDefaults standardUserDefaults] synchronize];
}

-(void) setTextPreset:(id)value forSpecifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];
    NSInteger val = [value integerValue];
    UIColor* col = nil;
    switch (val) {
        case 1:
            col = WhiteColour;
            break;

        case 2:
            col = BlackColour;
            break;

        case 3:
            col = DarkGreyColour;
            break;

        case 4:
            col = LightGreyColour;
            break;

        case 5:
            col = DarkBlueColour;
            break;

        case 6:
            col = LightBlueColour;
            break;

        case 7:
            col = GreenColour;
            break;

        case 8:
            col = RedColour;
            break;

        case 9:
            col = OrangeColour;
            break;

        case 10:
            col = YellowColour;
            break;

        case 11:
            col = PinkColour;
            break;

        case 12:
            col = PurpleColour;
            break;

        case 13:
            col = TealColour;
            break;

        case 14:
            col = MaroonColour;
            break;

        default:
            col = nil;
            break;
    }
    if (col) {
        const CGFloat* components = CGColorGetComponents(col.CGColor);
        [self setPreferenceValue:[NSNumber numberWithInt:components[0]*255] specifier:[self specifierForID:textRedName]];
        [self setPreferenceValue:[NSNumber numberWithInt:components[1]*255] specifier:[self specifierForID:textGreenName]];
        [self setPreferenceValue:[NSNumber numberWithInt:components[2]*255] specifier:[self specifierForID:textBlueName]];
    }
    [[NSUserDefaults standardUserDefaults] synchronize];
    [self updateTextPreviewInTime:0];
    [self reloadSpecifiers];
}

-(void) textSliderAlteredTo:(id)value specifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];
    CGFloat rVal = [[self readPreferenceValue:[self specifierForID:textRedName]] integerValue];
    CGFloat gVal = [[self readPreferenceValue:[self specifierForID:textGreenName]] integerValue];
    CGFloat bVal = [[self readPreferenceValue:[self specifierForID:textBlueName]] integerValue];
    UIColor* testColour = [UIColor colorWithRed:rVal/255.0 green:gVal/255.0 blue:bVal/255.0 alpha:1];
    if (testColour != WhiteColour && testColour != BlackColour && testColour != DarkBlueColour  && testColour != LightBlueColour  && testColour != DarkGreyColour && testColour != LightGreyColour && testColour != GreenColour && testColour != RedColour && testColour != OrangeColour && testColour != YellowColour && testColour != PinkColour && testColour != PurpleColour && testColour != TealColour && testColour != MaroonColour) {
        [self setPreferenceValue:[NSNumber numberWithInt:20] specifier:[self specifierForID:textPresetName]];
        [self reloadSpecifier:[self specifierForID:textPresetName]];
    }
    [self updateTextPreviewInTime:0.1];
    [[NSUserDefaults standardUserDefaults] synchronize];
}

-(void) invertGradient {
    NSInteger topR = [[self readPreferenceValue:[self specifierForID:bubbleTopRedName]] integerValue];
    NSInteger topG = [[self readPreferenceValue:[self specifierForID:bubbleTopGreenName]] integerValue];
    NSInteger topB = [[self readPreferenceValue:[self specifierForID:bubbleTopBlueName]]integerValue];
    NSInteger botR = [[self readPreferenceValue:[self specifierForID:bubbleBotRedName]]integerValue];
    NSInteger botG = [[self readPreferenceValue:[self specifierForID:bubbleBotGreenName]]integerValue];
    NSInteger botB = [[self readPreferenceValue:[self specifierForID:bubbleBotBlueName]]integerValue];

    [self setPreferenceValue:[NSNumber numberWithInt:botR] specifier:[self specifierForID:bubbleTopRedName]];
    [self setPreferenceValue:[NSNumber numberWithInt:botG] specifier:[self specifierForID:bubbleTopGreenName]];
    [self setPreferenceValue:[NSNumber numberWithInt:botB] specifier:[self specifierForID:bubbleTopBlueName]];
    [self setPreferenceValue:[NSNumber numberWithInt:topR] specifier:[self specifierForID:bubbleBotRedName]];
    [self setPreferenceValue:[NSNumber numberWithInt:topG] specifier:[self specifierForID:bubbleBotGreenName]];
    [self setPreferenceValue:[NSNumber numberWithInt:topB] specifier:[self specifierForID:bubbleBotBlueName]];

    [[NSUserDefaults standardUserDefaults] synchronize];
    [self performSelector:@selector(reloadSpecifiers) withObject:self afterDelay:0.2];
    [self updateBubblePreviewColourInTime:0.1];
}

-(void) updateBubblePreviewColourInTime:(CGFloat)t {
    [UIView animateWithDuration:t animations:^{
        CGFloat rValT = [[self readPreferenceValue:[self specifierForID:bubbleTopRedName]] integerValue];
        CGFloat gValT = [[self readPreferenceValue:[self specifierForID:bubbleTopGreenName]] integerValue];
        CGFloat bValT = [[self readPreferenceValue:[self specifierForID:bubbleTopBlueName]] integerValue];
        CGFloat aValT = [[self readPreferenceValue:[self specifierForID:bubbleTopAlphaName]] integerValue];
        UIColor* colT = [UIColor colorWithRed:rValT/255.0 green:gValT/255.0 blue:bValT/255.0 alpha:aValT/100.0];
        bubbleTopColourPreview.backgroundColor = colT;

        if (gradient) {
            CGFloat rValB = [[self readPreferenceValue:[self specifierForID:bubbleBotRedName]] integerValue];
            CGFloat gValB = [[self readPreferenceValue:[self specifierForID:bubbleBotGreenName]] integerValue];
            CGFloat bValB = [[self readPreferenceValue:[self specifierForID:bubbleBotBlueName]] integerValue];
            CGFloat aValB = [[self readPreferenceValue:[self specifierForID:bubbleBotAlphaName]] integerValue];
            UIColor* colB = [UIColor colorWithRed:rValB/255.0 green:gValB/255.0 blue:bValB/255.0 alpha:aValB/100.0];
            bubbleBotColourPreview.backgroundColor = colB;
        }
    }];
}

-(void) updateTextPreviewInTime:(CGFloat)t {
    [UIView animateWithDuration:t animations:^{
        CGFloat rValT = [[self readPreferenceValue:[self specifierForID:textRedName]] integerValue];
        CGFloat gValT = [[self readPreferenceValue:[self specifierForID:textGreenName]] integerValue];
        CGFloat bValT = [[self readPreferenceValue:[self specifierForID:textBlueName]] integerValue];
        UIColor* colT = [UIColor colorWithRed:rValT/255.0 green:gValT/255.0 blue:bValT/255.0 alpha:1];
        textColourPreview.backgroundColor = colT;
    }];
}

@end

@interface SMSBubblesController:BubblesController {}
@end

@implementation SMSBubblesController

-(void) setIDs {
    prefsName = @"SMSBubblePrefs";
    gradientName = @"SMSBubbleGradient";

    bubbleTopRedName = @"SMSBubbleTopRed";
    bubbleTopGreenName = @"SMSBubbleTopGreen";
    bubbleTopBlueName = @"SMSBubbleTopBlue";
    bubbleTopAlphaName = @"SMSBubbleOpacity";

    bubbleBotRedName = @"SMSBubbleBotRed";
    bubbleBotGreenName = @"SMSBubbleBotGreen";
    bubbleBotBlueName = @"SMSBubbleBotBlue";
    bubbleBotAlphaName = @"SMSBubbleOpacity";

    textRedName = @"SMSTextRed";
    textGreenName = @"SMSTextGreen";
    textBlueName = @"SMSTextBlue";
    textAlphaName = @"SMSTextAlpha";

    bubblePresetName = @"SMSBubbleColour";
    textPresetName = @"SMSTextColour";

    idsSet = YES;
}

@end

@interface IMBubblesController:BubblesController {}
@end

@implementation IMBubblesController

-(void) setIDs {
    prefsName = @"IMBubblePrefs";
    gradientName = @"IMBubbleGradient";

    bubbleTopRedName = @"IMBubbleTopRed";
    bubbleTopGreenName = @"IMBubbleTopGreen";
    bubbleTopBlueName = @"IMBubbleTopBlue";
    bubbleTopAlphaName = @"IMBubbleOpacity";

    bubbleBotRedName = @"IMBubbleBotRed";
    bubbleBotGreenName = @"IMBubbleBotGreen";
    bubbleBotBlueName = @"IMBubbleBotBlue";
    bubbleBotAlphaName = @"IMBubbleOpacity";

    textRedName = @"IMTextRed";
    textGreenName = @"IMTextGreen";
    textBlueName = @"IMTextBlue";
    textAlphaName = @"IMTextAlpha";

    bubblePresetName = @"IMBubbleColour";
    textPresetName = @"IMTextColour";

    idsSet = YES;
}

@end

@interface OtherBubblesController:BubblesController {}
@end

@implementation OtherBubblesController

-(void) setIDs {
    prefsName = @"OtherBubblePrefs";
    gradientName = @"OtherBubbleGradient";

    bubbleTopRedName = @"OtherBubbleTopRed";
    bubbleTopGreenName = @"OtherBubbleTopGreen";
    bubbleTopBlueName = @"OtherBubbleTopBlue";
    bubbleTopAlphaName = @"OtherBubbleOpacity";

    bubbleBotRedName = @"OtherBubbleBotRed";
    bubbleBotGreenName = @"OtherBubbleBotGreen";
    bubbleBotBlueName = @"OtherBubbleBotBlue";
    bubbleBotAlphaName = @"OtherBubbleOpacity";

    textRedName = @"OtherTextRed";
    textGreenName = @"OtherTextGreen";
    textBlueName = @"OtherTextBlue";

    bubblePresetName = @"OtherBubbleColour";
    textPresetName = @"OtherTextColour";

    idsSet = YES;
}

@end

@interface SingleColourPickerController:CHMCPSListController {
    NSString* plistName;
    NSString* presetName;
    NSString* redName;
    NSString* greenName;
    NSString* blueName;
    UIView* previewView;
    //NSInteger selectedPreset;
    BOOL idsSet;
}
@property (nonatomic, retain) PSSpecifier* presetSpecifier;
-(void) setIDs;
-(void) colourSliderAlteredTo:(id)value specifier:(id)specifier;
-(void) setColourPreset:(id)value specifier:(id)specifier;
-(void) updatePreviewInTime:(CGFloat)t;
@end

@implementation SingleColourPickerController

-(id) specifiers {
    if (! idsSet) {
        [self setIDs];
    }

    if (_specifiers == nil) {
        _specifiers = [self loadSpecifiersFromPlistName:plistName target:self];        // retain];
        self.presetSpecifier = [_specifiers objectAtIndex:1];
    }

    if (! previewView) {
        CGFloat rVal = [[self readPreferenceValue:[self specifierForID:redName]] integerValue];
        CGFloat gVal = [[self readPreferenceValue:[self specifierForID:greenName]] integerValue];
        CGFloat bVal = [[self readPreferenceValue:[self specifierForID:blueName]] integerValue];
        UIColor* colour = [UIColor colorWithRed:rVal/255.0 green:gVal/255.0 blue:bVal/255.0 alpha:1];
        UIView* view = nil;
        view = [[UIView alloc] initWithFrame:CGRectMake(prefsWidth, 32, 15, 15)];
        view.backgroundColor = colour;
        view.layer.cornerRadius = 7.5;
        [self.table addSubview:view];
        previewView = view;
    }
    return _specifiers;
}

-(void) setIDs {}

-(void) colourSliderAlteredTo:(id)value specifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];
    CGFloat rVal = [[self readPreferenceValue:[self specifierForID:redName]] integerValue];
    CGFloat gVal = [[self readPreferenceValue:[self specifierForID:greenName]] integerValue];
    CGFloat bVal = [[self readPreferenceValue:[self specifierForID:blueName]] integerValue];
    UIColor* testColour = [UIColor colorWithRed:rVal/255.0 green:gVal/255.0 blue:bVal/255.0 alpha:1];
    if (testColour != WhiteColour && testColour != BlackColour && testColour != DarkBlueColour  && testColour != LightBlueColour  && testColour != DarkGreyColour && testColour != LightGreyColour && testColour != GreenColour && testColour != RedColour && testColour != OrangeColour && testColour != YellowColour && testColour != PinkColour && testColour != PurpleColour && testColour != TealColour && testColour != MaroonColour) {
        [self setPreferenceValue:[NSNumber numberWithInt:20] specifier:[self specifierForID:presetName]];
        [self reloadSpecifier:[self specifierForID:presetName]];
    }
    [self updatePreviewInTime:0.1];
    [[NSUserDefaults standardUserDefaults] synchronize];
}

-(void) setColourPreset:(id)value specifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];
    NSInteger val = [value integerValue];
    //bubbleColourID = val
    UIColor* col = nil;
    switch (val) {
        case 1:
            col = WhiteColour;
            break;

        case 2:
            col = BlackColour;
            break;

        case 3:
            col = DarkGreyColour;
            break;

        case 4:
            col = LightGreyColour;
            break;

        case 5:
            col = DarkBlueColour;
            break;

        case 6:
            col = LightBlueColour;
            break;

        case 7:
            col = GreenColour;
            break;

        case 8:
            col = RedColour;
            break;

        case 9:
            col = OrangeColour;
            break;

        case 10:
            col = YellowColour;
            break;

        case 11:
            col = PinkColour;
            break;

        case 12:
            col = PurpleColour;
            break;

        case 13:
            col = TealColour;
            break;

        case 14:
            col = MaroonColour;
            break;

        default:
            col = nil;
            break;
    }
    if (col) {
        const CGFloat* components = CGColorGetComponents(col.CGColor);
        [self setPreferenceValue:[NSNumber numberWithInt:components[0]*255] specifier:[self specifierForID:redName]];
        [self setPreferenceValue:[NSNumber numberWithInt:components[1]*255] specifier:[self specifierForID:greenName]];
        [self setPreferenceValue:[NSNumber numberWithInt:components[2]*255] specifier:[self specifierForID:blueName]];
    }
    [[NSUserDefaults standardUserDefaults] synchronize];
    [self performSelector:@selector(reloadSpecifiers) withObject:self afterDelay:0.3];
    [self updatePreviewInTime:0.3];
}

-(void) updatePreviewInTime:(CGFloat)t {
    [UIView animateWithDuration:t animations:^{
        CGFloat rValT = [[self readPreferenceValue:[self specifierForID:redName]] integerValue];
        CGFloat gValT = [[self readPreferenceValue:[self specifierForID:greenName]] integerValue];
        CGFloat bValT = [[self readPreferenceValue:[self specifierForID:blueName]] integerValue];
        UIColor* colT = [UIColor colorWithRed:rValT/255.0 green:gValT/255.0 blue:bValT/255.0 alpha:1];
        previewView.backgroundColor = colT;
    }];
}

@end

@interface AppTintController:SingleColourPickerController {}
@end

@implementation AppTintController

-(void) setIDs {
    plistName = @"AppTintPrefs";
    presetName = @"TintColour";
    redName = @"TintRed";
    greenName = @"TintGreen";
    blueName = @"TintBlue";
}

@end

@interface InfoTextController:SingleColourPickerController {}
@end

@implementation InfoTextController

-(void) setIDs {
    plistName = @"InfoTextPrefs";
    presetName = @"InfoTextColour";
    redName = @"InfoTextRed";
    greenName = @"InfoTextGreen";
    blueName = @"InfoTextBlue";
}

@end

@interface BackgroundController:SingleColourPickerController <UINavigationControllerDelegate, UIImagePickerControllerDelegate>{
    BOOL image;
    BOOL wallpaper;
    BOOL blurred;
    UIImageView* imagePreview;
    NSString* imgPath;
}
-(void) pickImage;
-(void) setBlurred:(id)value specifier:(id)specifier;
-(void) updateImagePreview;
-(void) blurRadiusAltered:(id)value specifier:(id)specifier;
-(void) setBGOverlayTo:(id)value specifier:(id)specifier;
@end

@implementation BackgroundController

-(id) specifiers {
    if (! idsSet) {
        [self setIDs];
    }
    if (_specifiers == nil) {
        _specifiers = [self loadSpecifiersFromPlistName:plistName target:self];
        image = [[self readPreferenceValue:[self specifierForID:presetName]] integerValue] == 50;
        wallpaper = [[self readPreferenceValue:[self specifierForID:presetName]] integerValue] == 25;
        NSMutableArray* a = [[NSMutableArray alloc] init];
        if (image || wallpaper) {
            blurred = [[self readPreferenceValue:[self specifierForID:@"Blurred"]] boolValue];
            for (NSInteger i = 0; i < _specifiers.count; i++) {
                if (i != 2 && i != 3 && i != 4) {
                    if (image || (wallpaper && i != 6 && i != 7)) {
                        if (! blurred) {
                            if (i != 9 && i != 10 && i != 11 && i != 12) {
                                [a addObject:[_specifiers objectAtIndex:i]];
                            }
                        }
                        else {
                            [a addObject:[_specifiers objectAtIndex:i]];
                        }
                    }
                }
            }
        }
        else {
            for (NSInteger i = 0; i < _specifiers.count; i++) {
                if (i != 5 && i != 6 && i != 7 && i != 8 && i != 9 && i != 10 && i != 11 && i != 12) {
                    [a addObject:[_specifiers objectAtIndex:i]];
                }
            }
        }
        _specifiers = [a copy];
    }

    self.presetSpecifier = [_specifiers objectAtIndex:1];

    if (! previewView) {
        CGFloat rVal = 0;
        CGFloat gVal = 0;
        CGFloat bVal = 0;
        if (! image && ! wallpaper) {
            rVal = [[self readPreferenceValue:[self specifierForID:redName]] integerValue];
            gVal = [[self readPreferenceValue:[self specifierForID:greenName]] integerValue];
            bVal = [[self readPreferenceValue:[self specifierForID:blueName]] integerValue];
        }
        UIColor* colour = [UIColor colorWithRed:rVal/255.0 green:gVal/255.0 blue:bVal/255.0 alpha:1];
        UIView* view = [[UIView alloc] initWithFrame:CGRectMake(prefsWidth, 32, 15, 15)];
        view.backgroundColor = colour;
        view.layer.cornerRadius = 7.5;
        [self.table addSubview:view];
        if (image || wallpaper) {
            view.alpha = 0;
        }
        previewView = view;
        //  [view release];
    }

    if (! imagePreview) {
        UIImageView* view =  [[UIImageView alloc] initWithImage:nil];
        view.contentMode = UIViewContentModeScaleAspectFill;

        if (! image && ! wallpaper) {
            view.alpha = 0;
        }

        if (UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPad) {
            view.frame = CGRectMake(100, 250, 256, 192);
        }
        else {
            NSInteger h = 240;
            NSInteger w = [UIScreen mainScreen].bounds.size.width * (240/[UIScreen mainScreen].bounds.size.height);
            NSInteger oy = 218;
            if (wallpaper) {
                oy -= 44;
            }
            view.frame = CGRectMake((prefsWidth+25)/2 - w/2, oy, w, h);
        }
        view.layer.cornerRadius = 5;
        view.layer.masksToBounds = YES;
        [self.table addSubview:view];
        imagePreview = view;
        [self updateImagePreview];
    }
    else if (image || wallpaper) {
        imagePreview.alpha = 1;
        if (UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPad) {
            imagePreview.frame = CGRectMake(100, 250, 256, 192);
        }
        else {
            NSInteger h = 240;
            NSInteger w = [UIScreen mainScreen].bounds.size.width * (240/[UIScreen mainScreen].bounds.size.height);
            NSInteger oy = 218;
            if (wallpaper) {
                oy -= 44;
            }
            imagePreview.frame = CGRectMake((prefsWidth+25)/2 - w/2, oy, w, h);
        }
    }
    return _specifiers;
}

-(void) setIDs {
    plistName = @"BackgroundPrefs";
    presetName = @"BackgroundPreset";
    redName = @"BackgroundRed";
    greenName = @"BackgroundGreen";
    blueName = @"BackgroundBlue";
}

-(void) setColourPreset:(id)value specifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];
    NSInteger val = [value integerValue];
    UIColor* col = nil;
    switch (val) {
        case 1:
            col = WhiteColour;
            break;

        case 2:
            col = [UIColor colorWithRed:30/255.0 green:30/255.0 blue:30/255.0 alpha:1];
            break;

        case 3:
            col = DarkGreyColour;
            break;

        case 4:
            col = LightGreyColour;
            break;

        case 5:
            col = DarkBlueColour;
            break;

        case 6:
            col = LightBlueColour;
            break;

        case 7:
            col = GreenColour;
            break;

        case 8:
            col = RedColour;
            break;

        case 9:
            col = OrangeColour;
            break;

        case 10:
            col = YellowColour;
            break;

        case 11:
            col = PinkColour;
            break;

        case 12:
            col = PurpleColour;
            break;

        case 13:
            col = TealColour;
            break;

        case 14:
            col = MaroonColour;
            break;

        case 20:
            if (image || wallpaper) {
                col = BlackColour;
            }
            break;

        default:
            col = nil;
            break;
    }
    if (col) {
        if (image) {
            /*[self removeSpecifier:[self specifierForID:@"PickImage"] animated:YES];
               [self removeSpecifier:[self specifierForID:@"ImagePath"] animated:YES];
               [self removeSpecifier:[self specifierForID:@"Blurred"] animated:YES];
               [self removeSpecifier:[self specifierForID:@"ImageBG"] animated:YES];
               [self removeSpecifier:[self specifierForID:@"overlayColGroup"] animated:YES];*/
            id prefs = [self loadSpecifiersFromPlistName:plistName target:self];
            [self addSpecifier:[prefs objectAtIndex:2] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:3] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:4] animated:YES];
        }
        else if (wallpaper) {
            //[self removeSpecifier:[self specifierForID:@"overlayColGroup"] animated:YES];
            id prefs = [self loadSpecifiersFromPlistName:plistName target:self];
            [self addSpecifier:[prefs objectAtIndex:2] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:3] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:4] animated:YES];
        }
        image = NO;
        wallpaper = NO;
        const CGFloat* components = CGColorGetComponents(col.CGColor);
        [self setPreferenceValue:[NSNumber numberWithInt:components[0]*255] specifier:[self specifierForID:redName]];
        [self setPreferenceValue:[NSNumber numberWithInt:components[1]*255] specifier:[self specifierForID:greenName]];
        [self setPreferenceValue:[NSNumber numberWithInt:components[2]*255] specifier:[self specifierForID:blueName]];

        previewView.alpha = 1;
        imagePreview.alpha = 0;
        [self updatePreviewInTime:0];
    }
    else if (val == 25) {
        if (image) {
            /*[self removeSpecifier:[self specifierForID:@"PickImage"] animated:YES];
               [self removeSpecifier:[self specifierForID:@"ImagePath"] animated:YES];
               [self removeSpecifier:[self specifierForID:@"Blurred"] animated:YES];
               [self removeSpecifier:[self specifierForID:@"ImageBG"] animated:YES];
               [self removeSpecifier:[self specifierForID:@"overlayColGroup"] animated:YES];*/
        }
        else if (! wallpaper) {
            //[self removeSpecifier:[self specifierForID:redName] animated:YES];
            //[self removeSpecifier:[self specifierForID:greenName] animated:YES];
            //[self removeSpecifier:[self specifierForID:blueName] animated:YES];
            id prefs = [self loadSpecifiersFromPlistName:plistName target:self];
            [self addSpecifier:[prefs objectAtIndex:11] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:12] animated:YES];
        }
        image = NO;
        wallpaper = YES;
        previewView.alpha = 0;
        imagePreview.alpha = 1;
        [self updateImagePreview];
    }
    else if (val == 50) {
        if (! image && ! wallpaper) {
            id prefs = [self loadSpecifiersFromPlistName:plistName target:self];
            //[self removeSpecifier:[self specifierForID:redName] animated:YES];
            //[self removeSpecifier:[self specifierForID:greenName] animated:YES];
            //[self removeSpecifier:[self specifierForID:blueName] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:5] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:6] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:7] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:8] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:11] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:12] animated:YES];
        }
        else if (! image && wallpaper) {
            id prefs = [self loadSpecifiersFromPlistName:plistName target:self];
            [self addSpecifier:[prefs objectAtIndex:5] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:6] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:7] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:8] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:11] animated:YES];
            [self addSpecifier:[prefs objectAtIndex:12] animated:YES];
        }
        image = YES;
        wallpaper = NO;
        //if (!imagePreview.image) {
        [self updateImagePreview];
        //  }
        imagePreview.alpha = 1;
        previewView.alpha = 0;
    }
    else if (val == 20) {
        previewView.alpha = 1;
    }

    [[NSUserDefaults standardUserDefaults] synchronize];
    [self reloadSpecifiers];
}

-(void) pickImage {
    UIViewController* rootViewController = (UIViewController*)[[[UIApplication sharedApplication] keyWindow] rootViewController];
    UIImagePickerController* mediaUI = [[UIImagePickerController alloc] init];
    mediaUI.sourceType = UIImagePickerControllerSourceTypePhotoLibrary;
    //mediaUI.mediaTypes = [NSArray arrayWithObjects:kUTTypeImage,nil];
    mediaUI.allowsEditing = NO;
    mediaUI.delegate = self;
    [rootViewController presentViewController:mediaUI animated:YES completion:nil];
}

-(void) imagePickerController:(UIImagePickerController*)picker didFinishPickingMediaWithInfo:(NSDictionary*)info {
    NSString* mediaType = [info objectForKey:UIImagePickerControllerMediaType];
    UIImage* originalImage;
    if (CFStringCompare((CFStringRef)mediaType, kUTTypeImage, 0) == kCFCompareEqualTo) {
        originalImage = (UIImage*)[info objectForKey:
                                   UIImagePickerControllerOriginalImage];

        NSURL* url = [info valueForKey:UIImagePickerControllerReferenceURL];
        imgPath = (NSString*)url;
    }
    [[picker presentingViewController] dismissViewControllerAnimated:YES completion:nil];
    [self setPreferenceValue:[NSString stringWithFormat:@"%@", imgPath] specifier:[self specifierForID:@"ImagePath"]];
    [self updateImagePreview];
    [[NSUserDefaults standardUserDefaults] synchronize];
    [self reloadSpecifiers];
}

-(void) setBlurred:(id)value specifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];
    blurred = [value boolValue];
    if (blurred) {
        id prefs = [self loadSpecifiersFromPlistName:@"BackgroundPrefs" target:self];
        NSInteger start = [self indexOfSpecifierID:@"ImageBG"];
        [self insertSpecifier:[prefs objectAtIndex:9] afterSpecifier:[_specifiers objectAtIndex:start] animated:YES];
        [self insertSpecifier:[prefs objectAtIndex:10] afterSpecifier:[_specifiers objectAtIndex:start+1] animated:YES];
        [self insertSpecifier:[prefs objectAtIndex:11] afterSpecifier:[_specifiers objectAtIndex:start+2] animated:YES];
        [self insertSpecifier:[prefs objectAtIndex:12] afterSpecifier:[_specifiers objectAtIndex:start+3] animated:YES];
    }
    else {
        [self removeSpecifier:[self specifierForID:@"blurRadGroup"] animated:YES];
        [self removeSpecifier:[self specifierForID:@"overlayColGroup"] animated:YES];
    }
    [self updateImagePreview];
    [[NSUserDefaults standardUserDefaults] synchronize];
}

-(void) blurRadiusAltered:(id)value specifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];
    [[NSUserDefaults standardUserDefaults] synchronize];
    [self updateImagePreview];
}

-(void) updateImagePreview {
    if (image) {
        blurred = [[self readPreferenceValue:[self specifierForID:@"Blurred"]] boolValue];
        imgPath = [self readPreferenceValue:[self specifierForID:@"ImagePath"]];

        NSURL* url = [NSURL URLWithString:imgPath];
        ALAssetsLibrary* assetsLibrary = [[ALAssetsLibrary alloc] init];
        [assetsLibrary assetForURL:url resultBlock:^(ALAsset* asset) {
            ALAssetRepresentation* representation = [asset defaultRepresentation];
            if (representation.size <= 2500000) {
                CGImageRef imageRef = [representation fullScreenImage];
                if (imageRef) {
                    UIImage* img = [UIImage imageWithCGImage:imageRef scale:representation.scale orientation:representation.orientation];
                    if (blurred) {
                        CGFloat scale = 1.0;
                        if ([[UIScreen mainScreen]respondsToSelector:@selector(scale)]) {
                            CGFloat tmp = [[UIScreen mainScreen]scale];
                            if (tmp > 1.5) {
                                scale = 2.0;
                            }
                        }
                        UITableView* view = (UITableView*)self.table;
                        UIGraphicsBeginImageContextWithOptions(view.bounds.size, NO, scale);
                        [self.table drawViewHierarchyInRect:view.frame afterScreenUpdates:NO];
                        NSInteger imageBlurRad = [[self readPreferenceValue:[self specifierForID:@"BlurRadius"]] integerValue];
                        NSInteger overlayNum = [[self readPreferenceValue:[self specifierForID:@"BGOverlay"]] integerValue];
                        UIColor* overlayColor = [UIColor clearColor];
                        if (overlayNum == 2) {
                            overlayColor = [UIColor colorWithWhite:1.0 alpha:0.5];
                        }
                        else if (overlayNum == 3) {
                            overlayColor = [UIColor colorWithWhite:0.11 alpha:0.5];
                        }
                        img = [img applyEffectWithRadius:imageBlurRad andTintColour:overlayColor];
                        UIGraphicsEndImageContext();
                    }
                    [UIView transitionWithView:imagePreview
                     duration:0.2f
                     options:UIViewAnimationOptionTransitionCrossDissolve
                     animations:^{
                        imagePreview.image = img;
                    } completion:NULL];
                }
                else {
                    if (image && url) {
                        UIAlertView* alert = [[UIAlertView alloc] initWithTitle:@"Error!" message:@"There was an error loading the background image." delegate:self cancelButtonTitle:@"Oh No!" otherButtonTitles:nil];
                        [alert show];
                        [UIView transitionWithView:imagePreview
                         duration:0.2f
                         options:UIViewAnimationOptionTransitionCrossDissolve
                         animations:^{
                            imagePreview.image = nil;
                        } completion:NULL];
                    }
                }
            }
            else {
                UIAlertView* alert = [[UIAlertView alloc] initWithTitle:@"Error!" message:@"Background image is too large." delegate:self cancelButtonTitle:@"Oh No!" otherButtonTitles:nil];
                [alert show];
                [UIView transitionWithView:imagePreview
                 duration:0.2f
                 options:UIViewAnimationOptionTransitionCrossDissolve
                 animations:^{
                    imagePreview.image = nil;
                } completion:NULL];
            }
        } failureBlock:^(NSError* error) {
            UIAlertView* alert = [[UIAlertView alloc] initWithTitle:@"Error!" message:@"There was an error loading the background image." delegate:self cancelButtonTitle:@"Oh No!" otherButtonTitles:nil];
            [alert show];
            [UIView transitionWithView:imagePreview
             duration:0.2f
             options:UIViewAnimationOptionTransitionCrossDissolve
             animations:^{
                imagePreview.image = nil;
            } completion:NULL];
        }];
    }
    else { // wallpaper
        imgPath = nil;
        NSString* wallPath = @"/var/mobile/Library/SpringBoard/HomeBackground.cpbitmap";
        if (! [[NSFileManager defaultManager] fileExistsAtPath:wallPath]) {
            wallPath = @"/var/mobile/Library/SpringBoard/LockBackground.cpbitmap";
        }
        UIImage* wallimg = [UIImage imageWithContentsOfCPBitmapFile:wallPath flags:nil];
        [UIView transitionWithView:imagePreview
         duration:0.2f
         options:UIViewAnimationOptionTransitionCrossDissolve
         animations:^{
            imagePreview.image = wallimg;
        } completion:NULL];
    }
}

-(void) setBGOverlayTo:(id)value specifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];
    [[NSUserDefaults standardUserDefaults] synchronize];
    if (image) {
        [self updateImagePreview];
    }
}

@end

@interface ChatViewController:CHMCPSListController {}
-(void) setFlatEdges:(id)value specifier:(id)specifier;
@end

@implementation ChatViewController
-(id) specifiers {
    if (_specifiers == nil) {
        _specifiers = [self loadSpecifiersFromPlistName:@"ChatViewPrefs" target:self];
        BOOL fe = [[self readPreferenceValue:[self specifierForID:@"FlatEdges"]] boolValue];
        if (fe) {
            NSMutableArray* a = [[NSMutableArray alloc] init];
            for (NSInteger i = 0; i < _specifiers.count; i++) {
                if (i < 4 || i > 9) {
                    [a addObject:[_specifiers objectAtIndex:i]];
                }
            }
            _specifiers = [a copy];
        }
    }
    return _specifiers;
}

-(void) setFlatEdges:(id)value specifier:(id)specifier {
    [self setPreferenceValue:value specifier:specifier];

    BOOL v = [value boolValue];
    if (v) {
        [self setPreferenceValue:[NSNumber numberWithInt:0] specifier:[self specifierForID:@"SingleContactPics"]];
        [self setPreferenceValue:[NSNumber numberWithInt:0] specifier:[self specifierForID:@"GroupContactPics"]];
        [self setPreferenceValue:[NSNumber numberWithInt:0] specifier:[self specifierForID:@"MyContactPics"]];
        [[NSUserDefaults standardUserDefaults] synchronize];
        [self removeSpecifier:[self specifierForID:@"cpicgroup"] animated:YES];
        [self removeSpecifier:[self specifierForID:@"cpicradgroup"] animated:YES];
    }
    else {
        id prefs = [self loadSpecifiersFromPlistName:@"ChatViewPrefs" target:self];
        NSInteger start = [self indexOfSpecifierID:@"FlatEdges"];
        [self insertSpecifier:[prefs objectAtIndex:4] afterSpecifier:[_specifiers objectAtIndex:start] animated:YES]; // was 8
        [self insertSpecifier:[prefs objectAtIndex:5] afterSpecifier:[_specifiers objectAtIndex:start+1] animated:YES];
        [self insertSpecifier:[prefs objectAtIndex:6] afterSpecifier:[_specifiers objectAtIndex:start+2] animated:YES];
        [self insertSpecifier:[prefs objectAtIndex:7] afterSpecifier:[_specifiers objectAtIndex:start+3] animated:YES];
        [self insertSpecifier:[prefs objectAtIndex:8] afterSpecifier:[_specifiers objectAtIndex:start+4] animated:YES];
        [self insertSpecifier:[prefs objectAtIndex:9] afterSpecifier:[_specifiers objectAtIndex:start+5] animated:YES];
        [self setPreferenceValue:[NSNumber numberWithInt:1] specifier:[self specifierForID:@"GroupContactPics"]];
        [[NSUserDefaults standardUserDefaults] synchronize];
    }
    [[NSUserDefaults standardUserDefaults] synchronize];
    [self performSelector:@selector(reloadSpecifiers) withObject:self afterDelay:0.4];
}

@end

@interface UITableViewCell (chew)
-(id) _tableView;
@end

@interface ConvoViewController:CHMCPSListController {}
@end

@implementation ConvoViewController
-(id) specifiers {
    if (_specifiers == nil) {
        _specifiers = [self loadSpecifiersFromPlistName:@"ConvoListPrefs" target:self];        // retain];
    }
    return _specifiers;
}

@end

@interface MCBetterSliderCell:PSSliderTableCell <UIAlertViewDelegate, UITextFieldDelegate> {}
-(void) presentPopup;
@end

@implementation MCBetterSliderCell

-(id) initWithStyle:(NSInteger)arg1 reuseIdentifier:(id)arg2 specifier:(id)arg3 {
    self = [super initWithStyle:UITableViewCellStyleDefault reuseIdentifier:arg2 specifier:arg3];
    if (self) {
        CGRect frame = [self frame];

        UIButton* button = [UIButton buttonWithType:UIButtonTypeRoundedRect]; // retain];

        button.frame = CGRectMake(frame.size.width-50, 0, 50, frame.size.height);
        button.autoresizingMask = UIViewAutoresizingFlexibleLeftMargin;
        [button setTitle:@"" forState:UIControlStateNormal];
        [button addTarget:self action:@selector(presentPopup) forControlEvents:UIControlEventTouchUpInside];
        [self addSubview:button];
        //	[button release];
    }
    return self;
}

-(void) presentPopup {
    NSString* name = self.specifier.name;
    NSInteger max = 255;
    if ([name isEqual:@"Opacity"]) {
        max = 100;
    }
    UIAlertView* alert = [[UIAlertView alloc] initWithTitle:name
                          message:[NSString stringWithFormat:@"Enter value between 0 and %zd.", max]
                          delegate:self
                          cancelButtonTitle:@"Cancel"
                          otherButtonTitles:@"Enter"
                          , nil];
    alert.alertViewStyle = UIAlertViewStylePlainTextInput;
    [alert show];
    [[alert textFieldAtIndex:0] setDelegate:self];
    [[alert textFieldAtIndex:0] resignFirstResponder];
    [[alert textFieldAtIndex:0] setKeyboardType:UIKeyboardTypeNumberPad];
    [[alert textFieldAtIndex:0] becomeFirstResponder];
}

-(void) alertView:(UIAlertView*)alertView clickedButtonAtIndex:(NSInteger)buttonIndex {
    if (buttonIndex == 1) {
        NSInteger value = [[alertView textFieldAtIndex:0].text integerValue];
        [self setValue:[NSNumber numberWithInt:value]];
        [PSRootController setPreferenceValue:[NSNumber numberWithFloat:value] specifier:self.specifier];
        [[NSUserDefaults standardUserDefaults] synchronize];
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, 0.2 * NSEC_PER_SEC), dispatch_get_main_queue(), ^{
            CFNotificationCenterPostNotification(CFNotificationCenterGetDarwinNotifyCenter(), CFSTR("me.chewitt.MCPrefs.settingschanged"), NULL, NULL, YES);
        });
        UITableView* table = [self _tableView];
        id currentController = table.delegate;
        if ([currentController isKindOfClass:[SingleColourPickerController class]]) {
            SingleColourPickerController* controller = (SingleColourPickerController*)currentController;
            [PSRootController setPreferenceValue:[NSNumber numberWithInt:20] specifier:controller.presetSpecifier];
            [controller reloadSpecifier:controller.presetSpecifier];
            //[controller reloadSpecifier:self.specifier];
            [controller updatePreviewInTime:0.2];
        }
        else {
            BubblesController* controller = (BubblesController*)currentController;
            if ([self.specifier.identifier rangeOfString:@"Text"].location == NSNotFound && ! [self.specifier.name isEqual:@"Opacity"]) {
                [PSRootController setPreferenceValue:[NSNumber numberWithInt:20] specifier:controller.bubblePresetSpecifier];
                [controller reloadSpecifier:controller.bubblePresetSpecifier];
            }
            else {
                [PSRootController setPreferenceValue:[NSNumber numberWithInt:20] specifier:controller.textPresetSpecifier];
                [controller reloadSpecifier:controller.textPresetSpecifier];
            }
            //[controller reloadSpecifier:self.specifier];
            [controller updateBubblePreviewColourInTime:0.2];
            [controller updateTextPreviewInTime:0.2];
        }
    }
    [[alertView textFieldAtIndex:0] resignFirstResponder];
}

@end

@interface OtherViewController:CHMCPSListController {}
@end

@implementation OtherViewController

-(id) specifiers {
    if (_specifiers == nil) {
        _specifiers = [self loadSpecifiersFromPlistName:@"OtherSettingsPrefs" target:self];
    }
    return _specifiers;
}

@end

@interface CompatViewController:CHMCPSListController {}
@end

@implementation CompatViewController

-(id) specifiers {
    if (_specifiers == nil) {
        _specifiers = [self loadSpecifiersFromPlistName:@"CompatibilityPrefs" target:self];        // retain];
    }
    return _specifiers;
}

@end

@interface HelpViewController:CHMCPSListController {}
@end

@implementation HelpViewController

-(id) specifiers {
    if (_specifiers == nil) {
        _specifiers = [self loadSpecifiersFromPlistName:@"HelpPrefs" target:self];        // retain];
    }
    return _specifiers;
}

@end

@interface MCBannerCell:PSTableCell {}
@end

@implementation MCBannerCell
-(id) initWithStyle:(NSInteger)arg1 reuseIdentifier:(id)arg2 specifier:(id)arg3 {
    self = [super initWithStyle:UITableViewCellStyleDefault reuseIdentifier:arg2 specifier:arg3];
    if (self) {
        CGRect frame = [self frame];
        frame.size.height = 100;

        UIView* containerView = [[UIView alloc] initWithFrame:frame];
        containerView.autoresizingMask = UIViewAutoresizingFlexibleWidth;

        UIImageView* titleImage = [[UIImageView alloc] initWithFrame:frame];
        titleImage.contentMode = UIViewContentModeScaleAspectFill;
        titleImage.autoresizingMask = UIViewAutoresizingFlexibleWidth;

        if (iPad) {
            titleImage.image = [UIImage imageWithContentsOfFile:@"/Library/PreferenceBundles/MCProPrefs.bundle/banner_ipad.png"];
            containerView.clipsToBounds = YES;
            containerView.layer.cornerRadius = 5;
        }
        else {
            titleImage.image = [UIImage imageWithContentsOfFile:@"/Library/PreferenceBundles/MCPrefs.bundle/banner_iphone.png"];
        }

        [containerView addSubview:titleImage];
        [self.contentView addSubview:containerView];
    }
    return self;
}

@end

// vim:ft=objc
